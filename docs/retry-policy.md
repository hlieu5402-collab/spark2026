# 自适应 RetryAfter 策略

> 契约说明：本文档与 `spark_core::retry::adaptive::compute` 的“教案级”注释共同描述默认退避策略。
> 若调整算法或常量，必须同步更新两处信息，并补充测试覆盖。

## 策略矩阵（Strategy Matrix）

| 拥塞区间 (`backlog`) | RTT 区间 (`rtt`) | 退避系数 | 策略描述 |
| --- | --- | --- | --- |
| `0.0 .. 0.5` | `< 55ms` | `≈ 1.0x` | 保持基础冷却窗口，仅用于吸收瞬时抖动，避免误触发重试风暴。 |
| `0.5 .. 1.5` | `55ms .. 110ms` | `≈ 1.2x ~ 1.6x` | 队列开始积压，按照 backlog 的指数权重平滑放大等待时间。 |
| `1.5 .. 3.0` | `110ms .. 275ms` | `≈ 1.6x ~ 2.4x` | 拥塞明显，上调等待窗口并结合 RTT 权重抑制重试频率。 |
| `>= 3.0` | `> 275ms` | `≈ 2.4x ~ 3.0x`（饱和于上限） | 极端拥塞，直接靠近退避上限（3 秒）以等待系统恢复。 |

- **抖动 (Jitter)**：采用 SplitMix64 伪随机数，在 ±5% 内波动，确保同批请求不会同时醒来。
- **冷却 (Cooldown)**：无论 `base` 是否为零，最终等待时间不会低于 40ms，保证节律间隔。
- **饱和 (Cap)**：最大等待时间限定为 3 秒，防止长尾场景无限拉长退避而导致饥饿。

## 默认常量（Default Values）

| 常量 | 默认值 | 说明 |
| --- | --- | --- |
| `MIN_COOLDOWN` | 40ms | 当错误未携带等待时间或建议为 0 时的退避下限。 |
| `BASELINE_RTT` | 55ms | RTT 正常值基线，用于计算 `rtt` 放大系数。 |
| `BACKLOG_CEILING` | 4.0 | 拥塞归一化上限，代表“400% 队列占用”，超过后视作饱和。 |
| `BACKLOG_WEIGHT` | 0.65 | 背压主要来源于队列长度，因此给予更高权重。 |
| `RTT_WEIGHT` | 0.35 | RTT 反映网络抖动/跨机房延迟，用以纠正短期异常。 |
| `MAX_RTT_RATIO` | 6.0 | RTT 增益上界（约等于 330ms），避免尾部时延无限放大。 |
| `JITTER_RANGE` | ±5% | 抖动幅度，兼顾离散化与稳定性。 |
| `MAX_WAIT` | 3s | 自适应退避的封顶窗口。 |

## 使用提示（Operational Notes）

1. **兼容性**：算法仅依赖 `core` 与 `alloc`，可在 `no_std + alloc` 环境使用；
2. **监控建议**：建议同时采集 backlog、RTT 与最终 `RetryAfter`，对照本表验证策略是否符合预期；
3. **扩展空间**：若业务侧希望叠加指数退避，可在调用 `compute` 前修改 `base` 或在外层包裹倍增逻辑；
4. **测试约束**：任何改动需新增/更新 `tests::retry::adaptive_policy` 用例，验证拥塞爬升/回落场景下的误触发率。
