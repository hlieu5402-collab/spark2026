# PrometheusRule: Spark 指标契约 v1.0 样例告警
# 说明：Prometheus 在导入 OpenTelemetry 指标时会将 `.` 转换为 `_`，以下表达式基于该约定编写。
groups:
  - name: spark-core-observability
    interval: 30s
    rules:
      - alert: SparkServiceErrorRateHigh
        expr: |
          sum(rate(spark_request_total{outcome="error"}[5m]))
            /
          sum(rate(spark_request_total[5m]))
            > 0.05
        for: 5m
        labels:
          severity: warning
          team: spark-platform
        annotations:
          summary: "Spark 服务错误率超过 5%"
          description: |
            最近 5 分钟内，服务 {{ $labels.service_name }} (route={{ $labels.route_id }}) 的错误率达到 {{ $value | humanizePercentage }}。
            请检查依赖或回滚风险变更。

      - alert: SparkTransportConnectionFailures
        expr: |
          sum(increase(spark_transport_connection_failures[1m])) > 0
        for: 2m
        labels:
          severity: critical
          team: spark-network
        annotations:
          summary: "Spark 传输层连接连续失败"
          description: |
            传输协议 {{ $labels.transport_protocol }} 在监听 {{ $labels.listener_id }} 上连续出现连接失败。
            错误类型：{{ $labels.error_kind }}，请检查网络或证书配置。

      - alert: SparkCodecErrorSpike
        expr: |
          sum by (codec_name, content_type) (rate(spark_codec_decode_errors[5m]))
            /
          clamp_min(sum by (codec_name, content_type) (rate(spark_codec_decode_duration_count[5m])), 1)
            > 0.02
        for: 5m
        labels:
          severity: warning
          team: spark-runtime
        annotations:
          summary: "Spark Codec 解码错误率飙升"
          description: |
            编解码器 {{ $labels.codec_name }} (type={{ $labels.content_type }}) 的解码错误率高于 2%。
            请结合 payload 样例与上游变更排查数据格式或版本不兼容问题。
