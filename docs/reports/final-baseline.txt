T00 基线检查输出
================


$ rg -n -i 'enum\s+PollReady' --glob 'crates/spark-core/**'

$ rg -n -i '\bBackpressureReason\b' --glob 'crates/spark-core/**'

$ rg -n -i 'Busy\s*\(\s*.*Budget'
tools/ci/check_consistency.sh:289:#   2. 发现 `Busy(` 后跟踪括号深度，仅在该调用作用域内搜寻 `Budget`/`BudgetExhausted`；
tools/ci/check_consistency.sh:299:#   - 若业务使用 `let budget = ...; ReadyState::Busy(budget.into())` 且 `into` 内部才引用 `Budget`，

$ rg -n "fn .*\\(.*&ExecutionContext" crates/spark-core/src/transport/traits
crates/spark-core/src/transport/traits/object.rs:54:    fn local_addr_dyn(&self, ctx: &ExecutionContext<'_>) -> TransportSocketAddr;
crates/spark-core/src/transport/traits/object.rs:110:    fn local_addr_dyn(&self, ctx: &ExecutionContext<'_>) -> TransportSocketAddr {
crates/spark-core/src/transport/traits/object.rs:160:    fn scheme_dyn(&self, ctx: &ExecutionContext<'_>) -> &'static str;
crates/spark-core/src/transport/traits/object.rs:243:    fn scheme_dyn(&self, ctx: &ExecutionContext<'_>) -> &'static str {
crates/spark-core/src/transport/traits/generic.rs:60:    fn local_addr(&self, ctx: &ExecutionContext<'_>) -> TransportSocketAddr;
crates/spark-core/src/transport/traits/generic.rs:140:    fn scheme(&self, ctx: &ExecutionContext<'_>) -> &'static str;

$ cargo fmt --all --check

$ cargo clippy --workspace --all-targets -- -D warnings
    Checking spark-core v0.1.0 (/workspace/spark2026/crates/spark-core)
    Checking spark-deprecation-lint v0.1.0 (/workspace/spark2026/tools/spark-deprecation-lint)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.67s

$ cargo build --workspace
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.29s

$ cargo build --workspace --no-default-features --features alloc
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.15s

$ cargo clippy --workspace --all-targets -D warnings
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.34s

$ cargo test --workspace
   Compiling spark-core v0.1.0 (/workspace/spark2026/crates/spark-core)
   Compiling spark-codec-line v0.1.0 (/workspace/spark2026/crates/codecs/spark-codec-line)
   Compiling spark-contract-tests-macros v0.1.0 (/workspace/spark2026/crates/spark-contract-tests-macros)
    Finished `test` profile [unoptimized + debuginfo] target(s) in 5.38s
     Running unittests src/lib.rs (target/debug/deps/spark_codec_line-a842a357da99f91c)

running 4 tests
test line::tests::decode_marks_incomplete_without_newline ... ok
test line::tests::decode_respects_frame_budget ... ok
test line::tests::decode_returns_complete_when_newline_present ... ok
test line::tests::encode_appends_newline ... ok

test result: ok. 4 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running unittests src/lib.rs (target/debug/deps/spark_contract_tests-e762a7e663f76835)

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/mock_transport.rs (target/debug/deps/mock_transport-840684cb047cee46)

running 7 tests
test mock_transport_tck::cancellation_suite ... ok
test mock_transport_tck::backpressure_suite ... ok
test mock_transport_tck::errors_suite ... ok
test mock_transport_tck::hot_swap_suite ... ok
test mock_transport_tck::observability_suite ... ok
test mock_transport_tck::state_machine_suite ... ok
test mock_transport_tck::hot_reload_suite ... ok

test result: ok. 7 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running unittests src/lib.rs (target/debug/deps/spark_contract_tests_macros-2012f19abf3f7b58)

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running unittests src/lib.rs (target/debug/deps/spark_core-27b9b6413315706b)

running 30 tests
test buffer::message::tests::downcast_helpers_work_for_user_message ... ok
test buffer::message::tests::try_into_user_preserves_original_on_failure ... ok
test configuration::builder::tests::apply_change_detects_hash_gap ... ok
test configuration::builder::tests::apply_change_emits_audit_event ... ok
test configuration::builder::tests::apply_change_rolls_back_on_audit_failure ... ok
test configuration::builder::tests::build_generates_redacted_snapshot ... ok
test configuration::builder::tests::build_propagates_source_failure ... ok
test configuration::builder::tests::build_requires_profile ... ok
test configuration::builder::tests::build_requires_sources ... ok
test configuration::snapshot::tests::snapshot_redacts_encrypted_text ... ok
test deprecation::tests::emit_only_once ... ok
test deprecation::tests::emit_with_fields ... ok
[spark-core][deprecation] symbol=demo since=0.1.0 removal=0.3.0 tracking=None migration=None
test deprecation::tests::has_emitted_tracks_state ... ok
test error::tests::impl_to_domain_to_core_roundtrip_preserves_message_and_cause ... ok
test limits::tests::default_plan_matches_resource ... ok
test limits::tests::evaluate_queue_allows_until_capacity ... ok
test limits::tests::metrics_hook_records_drop_and_usage ... ok
test limits::tests::settings_parse_overrides ... ok
test observability::events::tests::application_event_helpers_work ... ok
test runtime::slo::tests::ensure_hot_reloadable_guard ... ok
test runtime::slo::tests::parse_and_evaluate_rule ... ok
test runtime::slo::tests::trigger_evaluate_with_hysteresis ... ok
test runtime::timeouts::tests::parsing_accepts_integer_and_duration_values ... ok
test runtime::timeouts::tests::runtime_config_updates_epoch ... ok
test status::ready::tests::budget_decision_exhausted_maps_to_budget_state ... ok
test status::ready::tests::budget_decision_granted_with_remaining_maps_to_ready ... ok
test status::ready::tests::budget_decision_granted_zero_remaining_maps_to_budget_state ... ok
test status::ready::tests::budget_exhaustion_maps_to_budget_state ... ok
test status::ready::tests::queue_full_maps_to_busy ... ok
test status::ready::tests::recovery_maps_to_ready ... ok

test result: ok. 30 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/codec_limits.rs (target/debug/deps/codec_limits-cdb8f6e48119e2c7)

running 3 tests
test decode_context_budget_consumption_and_refund ... ok
test decode_context_rejects_oversized_frame ... ok
test encode_context_budget_and_depth_behavior_matches_decoder ... ok

test result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/contracts/context_propagation_spawn.rs (target/debug/deps/contracts_context_propagation_spawn-38de5027f1ef0aeb)

running 2 tests
test tests::contracts::context_propagation_spawn::cancellation_reaches_spawned_task ... ok
test tests::contracts::context_propagation_spawn::deadline_expiry_propagates_cancel ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.04s

     Running tests/contracts/service_macro.rs (target/debug/deps/contracts_service_macro-da36d7e27c3e3fd7)

running 2 tests
test double_poll_no_ub ... ok
test poll_ready_pending_then_wake ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/dyn_bridge.rs (target/debug/deps/dyn_bridge-354afa65de14875a)

running 1 test
test into_dyn_bridge_roundtrip ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/errors_human_hint.rs (target/debug/deps/errors_human_hint-eba0b0f50874009f)

running 2 tests
test errors_human_hint_known_code ... ok
test errors_human_hint_unknown_code ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/hotreload.rs (target/debug/deps/hotreload-9f51db03ebad0693)

running 1 test
test tests::hotreload::hot_reload_limits_and_timeouts_is_atomic ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/loom_concurrency.rs (target/debug/deps/loom_concurrency-e49e1edaccced35d)

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/observability/mod.rs (target/debug/deps/observability-4703fee221304608)

running 1 test
test trace_autoinject::trace_context_auto_injected_and_spans_form_parent_child_tree ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/pipeline/mod.rs (target/debug/deps/pipeline-42e696d366f2c035)

running 1 test
test hot_swap::hot_swap_inserts_handler_without_dropping_messages ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/slo_policy_map.rs (target/debug/deps/slo_policy_map-c5e287df94b6ec5c)

running 1 test
test slo_policy_mapping_baseline ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running tests/state_machine_properties.rs (target/debug/deps/state_machine_properties-37213df94878e6d8)

running 2 tests
test prop_legal_sequences_have_no_unreachable_state ... ok
test prop_pending_intervals_have_visible_wake ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.02s

     Running unittests src/lib.rs (target/debug/deps/spark_otel-866dd2284a668794)

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

   Doc-tests spark_codec_line

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

   Doc-tests spark_contract_tests

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

   Doc-tests spark_contract_tests_macros

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

   Doc-tests spark_core

running 8 tests
test crates/spark-core/src/buffer/pool.rs - buffer::pool::BufferPool (line 32) ... ok
test crates/spark-core/src/buffer/message.rs - buffer::message::PipelineMessage (line 122) ... ok
test crates/spark-core/src/cluster/flow_control.rs - cluster::flow_control::SubscriptionStream (line 145) ... ignored
test crates/spark-core/src/buffer/pool.rs - buffer::pool::PoolStats (line 216) ... ok
test crates/spark-core/src/error.rs - error::CoreError::new (line 71) ... ok
test crates/spark-core/src/observability/events.rs - observability::events::OpsEventBus::set_event_policy (line 391) ... ignored
test crates/spark-core/src/security/policy.rs - security::policy (line 9) ... ignored
test crates/spark-core/src/observability/events.rs - observability::events::CoreUserEvent (line 111) ... ok

test result: ok. 5 passed; 0 failed; 3 ignored; 0 measured; 0 filtered out; finished in 0.01s

   Doc-tests spark_macros

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

   Doc-tests spark_otel

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s


$ cargo doc --workspace
 Documenting spark-core v0.1.0 (/workspace/spark2026/crates/spark-core)
 Documenting spark-otel v0.1.0 (/workspace/spark2026/crates/spark-otel)
 Documenting spark-contract-tests v0.1.0 (/workspace/spark2026/crates/spark-contract-tests)
 Documenting spark-codec-line v0.1.0 (/workspace/spark2026/crates/codecs/spark-codec-line)
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 4.70s
   Generated /workspace/spark2026/target/doc/spark_codec_line/index.html and 7 other files

$ cargo bench --workspace -- --quick
    Finished `bench` profile [optimized] target(s) in 0.18s
     Running benches/async_contract_overhead.rs (target/release/deps/async_contract_overhead-323e2738421f1cf8)
future_inline_elapsed_ns=1292393
future_inline_per_iter_ns=6.4620
future_boxed_elapsed_ns=1251597
future_boxed_per_iter_ns=6.2580
stream_inline_elapsed_ns=310693
stream_inline_per_iter_ns=6.2139
stream_boxed_elapsed_ns=302675
stream_boxed_per_iter_ns=6.0535
future_overhead_ratio=0.968
stream_overhead_ratio=0.974
     Running benches/buffer_roundtrip.rs (target/release/deps/buffer_roundtrip-b311c118bb2cf6e1)
Gnuplot not found, using plotters backend
Benchmarking buffer_roundtrip
Benchmarking buffer_roundtrip: Warming up for 100.00 ms
Benchmarking buffer_roundtrip: Collecting 10 samples in estimated 250.00 ms (3.2M iterations)
Benchmarking buffer_roundtrip: Analyzing
buffer_roundtrip        time:   [74.522 ns 81.323 ns 93.781 ns]
                        change: [+1.7998% +10.357% +19.042%] (p = 0.05 > 0.05)
                        No change in performance detected.

     Running benches/codec.rs (target/release/deps/codec-3ee18654b5b8c85f)
Gnuplot not found, using plotters backend
Benchmarking noop
Benchmarking noop: Analyzing
noop                    time:   [39.025 ps 39.128 ps 39.541 ps]
                        change: [-1.8302% -0.7276% +0.3851%] (p = 0.50 > 0.05)
                        No change in performance detected.

     Running benches/configuration.rs (target/release/deps/configuration-7ea3143fff398030)
Gnuplot not found, using plotters backend
Benchmarking configuration_build_static_layer
Benchmarking configuration_build_static_layer: Analyzing
configuration_build_static_layer
                        time:   [2.3317 µs 2.3457 µs 2.4016 µs]
                        change: [-2.4392% -0.1267% +2.2257%] (p = 0.87 > 0.05)
                        No change in performance detected.

     Running benches/smoke.rs (target/release/deps/smoke-0a327e5cafa7ab3f)
smoke_iterations=10000
smoke_elapsed_ns=171

$ make ci-lints
cargo fmt --all --check
cargo clippy --workspace --all-targets -- -D warnings
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.37s
cargo run --quiet --package spark-deprecation-lint

$ make ci-zc-asm
cargo build --workspace
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.16s

$ make ci-no-std-alloc
cargo build --workspace --no-default-features --features alloc
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.18s

$ make ci-doc-warning
cargo doc --workspace
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.18s
   Generated /workspace/spark2026/target/doc/spark_codec_line/index.html and 7 other files

$ make ci-bench-smoke
# `spark-macros` 为 proc-macro crate，未引入 Criterion，因此需排除以避免 `--quick` 参数触发 libtest 错误。
cargo bench --workspace --exclude spark-macros -- --quick
    Finished `bench` profile [optimized] target(s) in 0.21s
     Running benches/async_contract_overhead.rs (target/release/deps/async_contract_overhead-323e2738421f1cf8)
future_inline_elapsed_ns=1399856
future_inline_per_iter_ns=6.9993
future_boxed_elapsed_ns=1531375
future_boxed_per_iter_ns=7.6569
stream_inline_elapsed_ns=322838
stream_inline_per_iter_ns=6.4568
stream_boxed_elapsed_ns=356370
stream_boxed_per_iter_ns=7.1274
future_overhead_ratio=1.094
stream_overhead_ratio=1.104
     Running benches/buffer_roundtrip.rs (target/release/deps/buffer_roundtrip-b311c118bb2cf6e1)
Gnuplot not found, using plotters backend
Benchmarking buffer_roundtrip
Benchmarking buffer_roundtrip: Warming up for 100.00 ms
Benchmarking buffer_roundtrip: Collecting 10 samples in estimated 250.00 ms (2.9M iterations)
Benchmarking buffer_roundtrip: Analyzing
buffer_roundtrip        time:   [80.606 ns 91.648 ns 101.84 ns]
                        change: [-7.7531% +3.0302% +15.821%] (p = 0.63 > 0.05)
                        No change in performance detected.

     Running benches/codec.rs (target/release/deps/codec-3ee18654b5b8c85f)
Gnuplot not found, using plotters backend
Benchmarking noop
Benchmarking noop: Analyzing
noop                    time:   [37.979 ps 39.181 ps 39.481 ps]
                        change: [-3.9494% -1.4067% +1.1697%] (p = 0.60 > 0.05)
                        No change in performance detected.

     Running benches/configuration.rs (target/release/deps/configuration-7ea3143fff398030)
Gnuplot not found, using plotters backend
Benchmarking configuration_build_static_layer
Benchmarking configuration_build_static_layer: Analyzing
configuration_build_static_layer
                        time:   [2.3250 µs 2.3314 µs 2.3571 µs]
                        change: [-3.1917% -1.0824% +1.0900%] (p = 0.58 > 0.05)
                        No change in performance detected.

     Running benches/smoke.rs (target/release/deps/smoke-0a327e5cafa7ab3f)
smoke_iterations=10000
smoke_elapsed_ns=149
